### 项目文档

这是一个地形浏览器工具，允许用户输入体素坐标 (voxel coordinates) 来查询、解码和可视化链上游戏世界中的地形数据。它还可以获取玩家当前位置并显示对应的地形，同时能将地形数据作为蓝图发送回游戏中。

---

### 文件结构与功能说明

#### `package.json`
- **功能**: 项目的配置文件。它定义了项目的基本信息、依赖项 (如 `viem`, `dustkit`) 和可用的 `npm` 脚本 (如 `dev`, `build`)。

#### `index.html`
- **功能**: 应用的骨架，定义了用户界面的所有 HTML 元素。
- **主要元素**:
    - **坐标输入**: 用于输入 X, Y, Z 体素坐标和区块坐标的表单。
    - **控制按钮**: "获取地形" 和 "获取玩家位置" 的按钮。
    - **数据展示区**: 用于显示区块地址、原始地形数据、解码后的数据头和调试信息的区域。
    - **地形可视化**:
        - `slice-container`: 用于展示地形 2D 切片的网格容器。
        - `y-slider`: 用于选择要显示的 Y 轴切片高度的滑块。
    - **颜色选择器**: `color-picker-container` 用于动态生成颜色选择器。

---

### `src/` 源码目录

#### `src/main.ts`
- **功能**: 项目的 **主入口文件**。它的职责是启动整个应用程序。
- **执行逻辑**:
    1.  导入全局样式 `style.css`。
    2.  从 `src/dom.ts` 导入 `initializeApp` 函数。
    3.  调用 `initializeApp()` 来初始化应用。

#### `src/dom.ts`
- **功能**: 负责所有 **DOM 操作**、**事件监听器设置** 和 **UI 初始化**。这个模块是连接用户界面和应用逻辑的桥梁。
- **主要函数**:
    - `initializeApp()`: 在 `DOMContentLoaded` 事件触发后执行。它调用其他函数来设置坐标输入的同步、为按钮绑定事件处理器以及初始化UI组件。
    - `setupToggleArrow(arrowId, targetId)`: 为UI中的可折叠区域（如地形数据、调试信息等）设置点击事件，以实现展开和收起的功能。
    - `initializeCoordSync()`: 初始化体素坐标和区块坐标输入框之间的双向同步。当用户在一个输入框中输入时，另一组相关的坐标会自动计算并更新。
    - `setupSliceControls(y, data, highlight)`: 设置 Y 轴滑块的范围和初始值，并为其绑定 `input` 事件，以便在拖动滑块时重新渲染地形切片。
    - `clearOutput()`: 一个工具函数，用于在每次新的地形查询之前清空之前显示的数据和错误信息。

#### `src/handlers.ts`
- **功能**: 包含响应用户交互的 **核心应用逻辑**。这些函数通常是异步的，因为它们需要与外部服务（如区块链或游戏客户端）通信。
- **主要函数**:
    - `getPlayerPosition()`: 异步函数。连接到游戏客户端，获取玩家当前实体的精确位置，然后用这个位置更新 UI 中的坐标输入框，并自动触发一次地形获取。
    - `handleFetchTerrain(isPlayerPosition)`: 应用的核心函数。它从 UI 读取坐标，调用 `getTerrainData` 获取地形数据，然后解码数据头，更新 UI 上的各个信息面板，并调用 `displaySlice` 和 `setBlueprintOfChunk` 来可视化和发送蓝图。
    - `setBlueprintOfChunk(data, chunkX, chunkY, chunkZ)`: 异步函数。解析地形数据中的所有非空气方块，并将它们的位置和类型打包，通过游戏客户端的 `setBlueprint` 方法发送，以便在游戏中显示为蓝图。

#### `src/ui.ts`
- **功能**: 负责 **数据可视化** 的具体实现，主要是地形切片的渲染和颜色管理。
- **主要函数**:
    - `initializeColorPickers()`: 动态创建一组颜色选择器，并将其添加到页面中。每个选择器对应一种方块类型（如空气、石头、水），允许用户自定义这些方块在地形切片中的显示颜色。
    - `displaySlice(data, yValue, highlight)`: 根据给定的地形数据和 Y 轴高度，生成一个 16x16 的 2D 网格来代表一个地形切片。它会为每个方块创建一个 `div`，并根据其类型和用户选择的颜色进行着色。同时，它还能高亮显示玩家当前所在的位置。

#### `src/terrain.ts`
- **功能**: 封装了与 **地形数据结构** 和 **数据获取** 相关的所有逻辑。
- **主要常量和函数**:
    - `CHUNK_WIDTH`: 定义了区块（Chunk）的宽度（16个方块）。
    - `voxelToChunkPos(p)`: 将一个世界中的绝对体素坐标转换为其所在的区块坐标。
    - `chunkToVoxelPos(chunkCoord)`: 将区块坐标转换为该区块的原点（最小角的）体素坐标。
    - `getTerrainData(x, y, z)`: 接收体素坐标，通过一系列计算（调用 `address.ts` 中的函数）推导出对应的链上合约地址，然后使用 `viem` 客户端获取该地址的字节码，即原始地形数据。
    - `decodeTerrainHeader(hexData)`: 解析地形数据的头部字节，提取出版本、生物群系和地表类型等元数据。

#### `src/address.ts`
- **功能**: 一个专门的模块，用于处理复杂的 **链上地址计算** 逻辑。
- **主要函数**:
    - `getChunkSalt(coord)`: 根据区块坐标，通过位运算和填充生成一个确定性的、32字节的盐（salt），这是 CREATE3 地址计算的关键部分。
    - `getCreate3Address_TS(opts)`: 实现了 CREATE3 地址推导算法。它使用部署者地址和盐来计算出代理合约（proxy）的地址，并最终推导出区块合约的最终地址，而无需实际部署。

#### `src/math.ts`
- **功能**: 提供通用的 **数学工具**。
- **主要内容**:
    - `Vec3` 类: 一个简单的三维向量类，提供了向量的构造、缩放和取整等基本操作。
    - `packVec3(coords)`: 将一个三维坐标 `[x, y, z]` 打包成一个 `bigint` 类型，用于盐的生成。

#### `src/viem.ts`
- **功能**: 设置和导出与 **区块链交互的客户端**。
- **主要导出**:
    - `client`: 一个配置好的 `viem` 客户端实例，用于与以太坊兼容的链进行通信。
    - `worldAddress`: 游戏世界主合约的地址。
    - `DEFAULT_CREATE3_PROXY_INITCODE_HASH`: CREATE3 计算中使用的代理合约的默认初始化代码哈希。